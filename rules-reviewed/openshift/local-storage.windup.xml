<?xml version="1.0"?>
<ruleset id="local-storage" xmlns="http://windup.jboss.org/schema/jboss-ruleset" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://windup.jboss.org/schema/jboss-ruleset http://windup.jboss.org/schema/jboss-ruleset/windup-jboss-ruleset.xsd">
    <metadata>
        <description>
            This is a ruleset for local storage related suggestions for migrating to OpenShift environments.
        </description>
        <dependencies>
            <addon id="org.jboss.windup.rules,windup-rules-javaee,2.7.0.Final" />
            <addon id="org.jboss.windup.rules,windup-rules-java,2.7.0.Final" />
        </dependencies>
        <targetTechnology id="cloud-readiness" />
        <tag>openshift</tag>
        <tag>reviewed-2017-01-04</tag>
    </metadata>
    <rules>
        <rule id="local-storage-00001">
            <when>
                <or>
                    <javaclass references="java.io.{ioclass}{*}">
                        <location>CONSTRUCTOR_CALL</location>
                    </javaclass>
                    <javaclass references="java.util.zip.ZipFile{*}">
                        <location>CONSTRUCTOR_CALL</location>
                    </javaclass>
                    <javaclass references="java.io.File.createTempFile({*})">
                        <location>METHOD_CALL</location>
                    </javaclass>
                    <javaclass references="java.nio.file.Paths.get({*})">
                        <location>METHOD_CALL</location>
                    </javaclass>
                </or>
            </when>
            <perform>
                <hint title="Java APIs for local file system" effort="1" category-id="optional">
                    <message>
                    Java APIs for local file system identified in the file.  
                    Local files in containers are not permanent storage and can disappear when an instance of the application terminates.  
                    Avoid accessing local filesystems from applications running in OpenShift environments, and consider using a database or cloud-based storage system instead.
                    </message>
                    <link href="https://docs.openshift.com/container-platform/3.4/architecture/additional_concepts/storage.html" title="OpenShift with persistent storage (Concepts)"></link>
                </hint>
            </perform>
            <where param="ioclass">
                <matches pattern="(FileWriter|FileReader|PrintStream|File|PrintWriter|RandomAccessFile)"/>
            </where>
        </rule>
        <rule id="local-storage-00002">
            <when>
                <javaclass references="java.net.{class}{*file*}">
                    <location>CONSTRUCTOR_CALL</location>
                </javaclass>
            </when>
            <perform>
                <hint title="Used class java.net.URL/URI with local path" effort="1" category-id="optional">
                    <message>
                    Java API for java.net.URL/URI with local path identified in the file.  
                    Local files in containers are not permanent storage and can disappear when an instance of the application terminates.  
                    Avoid accessing local filesystems from applications running in OpenShift environments, and consider using a database or cloud-based storage system instead.
                    </message>
                    <link href="https://docs.openshift.com/container-platform/3.4/architecture/additional_concepts/storage.html" title="OpenShift with persistent storage (Concepts)"></link>
                </hint>
            </perform>
            <where param="class">
                <matches pattern="(URL|URI)" />
            </where>
        </rule>
        <rule id="local-storage-00003">
            <when>
                <filecontent pattern="{path1}" filename="{*}"/>
            </when>
            <perform>
                <hint title="Detected local file system paths" effort="1" category-id="potential">
                    <message>
                    Detected local file system path in the file.  
                    Local files in containers are not permanent storage and can disappear when an instance of the application terminates.  
                    Avoid accessing local filesystems from applications running in OpenShift environments, and consider using a database or cloud-based storage system instead.
                    </message>
                    <link href="https://docs.openshift.com/container-platform/3.4/architecture/additional_concepts/storage.html" title="OpenShift with persistent storage (Concepts)"></link>
                </hint>
            </perform>
            <where param="path1">
                <!-- absolute paths on windows -->
                <matches pattern="(([a-zA-Z]):)(?&lt;![\&lt;\\\/\d\w])([\\\/]\w+)+(\.\w+)?" />
            </where>
        </rule>
        <rule id="local-storage-00004">
            <when>
                <filecontent pattern="{path2}" filename="{*}"/>
            </when>
            <perform>
                <hint title="Detected URL with local file system path" effort="1" category-id="potential">
                    <message>
                    Detected URL with local file system path.  
                    Local files in containers are not permanent storage and can disappear when an instance of the application terminates.  
                    Avoid accessing local filesystems from applications running in OpenShift environments, and consider using a database or cloud-based storage system instead.
                    </message>
                    <link href="https://docs.openshift.com/container-platform/3.4/architecture/additional_concepts/storage.html" title="OpenShift with persistent storage (Concepts)"></link>
                </hint>
            </perform>
            <where param="path2">
                <!-- URL with local path -->
                <matches pattern="file://" />
            </where>
        </rule>
        <rule id="local-storage-00005">
            <when>
              <or>
                  <javaclass references="java.nio.channels.AsynchronousFileChannel{*}" />
                  <javaclass references="java.nio.channels.FileChannel{*}" />
                  <javaclass references="java.nio.channels.FileLock{*}" />
                  <javaclass references="java.nio.file.DirectoryStream{*}" />
                  <javaclass references="java.nio.file.Files{*}" />
                  <javaclass references="java.nio.file.FileStore{*}" />
                  <javaclass references="java.nio.file.FileSystem{*}" />
                  <javaclass references="java.nio.file.FileSystems{*}" />
                  <javaclass references="java.nio.file.Path{*}" />
                  <javaclass references="java.nio.file.Paths{*}" />
              </or>
            </when>
            <perform>
              <iteration>
                <hint title="Java APIs for local file system (java.nio classes)" effort="3" category-id="openshift-optional">
                    <message>
                        Java APIs for local file system identified in the file.  
                        Local files in containers are not permanent storage and can disappear when an instance of the application terminates.  
                        Avoid accessing local filesystems from applications running in OpenShift environments.  
                        Consider using a database or an object storage system instead or the recommended practice to have a persistent storage.
                    </message>
                    <link href="https://docs.openshift.com/container-platform/3.4/architecture/additional_concepts/storage.html" title="OpenShift with persistent storage (Concepts)"></link>
                    <link href="https://docs.openshift.com/container-platform/3.4/install_config/persistent_storage/index.html" title="OpenShift with persistent storage (Configure)"></link>
                    <link href="https://blog.openshift.com/experimenting-with-persistent-volumes/" title="OpenShift with persistent storage (blog post)"></link>
                    <link href="https://blog.openshift.com/openshift-applications-using-object-storage/" title="OpenShift with object storage"></link>
                    <tag>storage</tag>
                </hint>
              </iteration>
            </perform>
        </rule>
    </rules>
</ruleset>
